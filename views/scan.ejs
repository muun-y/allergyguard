<%- include("templates/header") %>
    <%- include("templates/navbar") %>

        <div class="p-6 max-w-xl mx-auto bg-white rounded shadow">
            <a href="/" class="flex justify-end text-blue-600 hover:underline text-sm">← Back to Home</a>
            <h2 class="text-xl font-semibold mb-4">Scan a Food Label</h2>

            <!-- Upload Image -->
            <input type="file" id="image-upload" accept="image/*" class="mb-4 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4
                file:rounded-full file:border-0 file:text-sm file:font-semibold
                file:bg-black file:text-white hover:file:bg-gray-800" />

            <!-- Preview -->
            <div id="preview-container" class="hidden mb-4">
                <p class="text-sm text-gray-600 mb-2">Preview:</p>
                <img id="preview" class="max-h-64 border rounded" />
            </div>

            <!-- Run OCR -->
            <button id="scan-btn"
                class="w-full md:w-auto text-center bg-black hover:bg-gray-800 text-white font-semibold px-6 py-3 rounded shadow disabled:opacity-50"
                disabled>
                Run OCR
            </button>

            <!-- Result -->
            <div id="scan-result" class="mt-4 text-sm text-gray-700"></div>
        </div>

        <%- include("templates/footer") %>

            <!-- Tesseract.js -->
            <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

            <script>
                const upload = document.getElementById("image-upload");
                const previewContainer = document.getElementById("preview-container");
                const preview = document.getElementById("preview");
                const scanBtn = document.getElementById("scan-btn");
                const resultBox = document.getElementById("scan-result");

                let selectedFile = null;
                let uploadedUrl = null;

                // Cloudinary upload+preview
                upload.addEventListener("change", async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    selectedFile = file;
                    const formData = new FormData();
                    formData.append("file", file);

                    try {
                        const res = await fetch("/api/upload", {
                            method: "POST",
                            body: formData,
                            credentials: "include",
                        });
                        const data = await res.json();

                        if (data.url) {
                            uploadedUrl = data.url;
                            preview.src = uploadedUrl;
                            previewContainer.classList.remove("hidden");
                            scanBtn.disabled = false;
                        }
                    } catch (err) {
                        console.error("Upload error:", err);
                        alert("Upload failed");
                    }
                });

                // Run OCR
                scanBtn.addEventListener("click", async () => {
                    if (!uploadedUrl) return;

                    resultBox.textContent = "⏳ Running OCR...";

                    try {
                        const { data: { text } } = await Tesseract.recognize(
                            uploadedUrl,
                            "eng",
                            { logger: m => console.log(m) }
                        );

                        let ingredientsText = text;
                        const lower = text.toLowerCase();
                        const idx = lower.indexOf("ingredients");
                        if (idx !== -1) {
                            ingredientsText = text.substring(idx);
                        }

                        const res = await fetch("/api/scan/match", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ text: ingredientsText, image: uploadedUrl }),
                            credentials: "include",
                        });

                        const data = await res.json();

                        resultBox.innerHTML = `
                  <p class="font-medium">OCR Result (Ingredients section):</p>
                  <pre class="whitespace-pre-wrap bg-gray-50 p-2 rounded border">${ingredientsText}</pre>
                `;

                        if (data.matched && data.matched.length > 0) {
                            resultBox.innerHTML += `
                    <h2 class="mt-2 text-red-600 font-semibold">
                      ⚠️ Warning! Found allergens: ${data.matched.join(", ")}
                    </h2>
                  `;
                        } else {
                            resultBox.innerHTML += `
                    <p class="mt-2 text-green-600 font-semibold">✅ No allergens found.</p>
                  `;
                        }
                    } catch (err) {
                        console.error("OCR error:", err);
                        resultBox.textContent = "❌ Scan Failed. Please try again.";
                    }
                });
            </script>